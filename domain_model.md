# ServiceManager

Cистема CRM для телекоммуникационной компании.

## Сущности
```
Первичный ключ для каждой сущности в тексте не указан и подразумевается по умолчанию
```

### User
- Внешняя сущность - существует на уровне Keycloak.

### Role
- Внешняя сущность - существует на уровне Keycloak
- Возможные варианты значений:
  - HelpDeskUser
  - SL3User
  - HelpDeskManager
  - SL3Manager

### Клиент
- Операции с клиентом:
   - Если клиент по его phone number находится в Legacy DB: то клиент подтягивается из Legacy DB и в поле **legacyclientid** прописывается его ID в Legacy DB
   - Если клиент по его phone number не находится в Legacy DB: новый клиент заводится как новая сущность в нашей DB и она соединяется с данным обращением, при этом поле **legacyclientid** = NULL
- Клиент характеризуется:
  - Имя
  - Фамилия
  - Отчество
  - Номер телефона - Unique constraint
  - email
  - ИНН (заполняется для юрика)
  - Название организации (заполняется для юрика)

### Услуга
- числовой код услуги - Unique constraint
- Название услуги
- Ссылка на связанную сущность **Рабочая группа**

### Рабочая группа
- числовой код рабочей группы - Unique constraint
- Название рабочей группы
- групповой email
- managerid - это не FK а KeyCloak ID для данного менеджера группы

``
Справочники Услуг и Рабочих групп поддерживаются и обновляются вне данной системы
``

### Обращение
- Создается по звонку клиента (возможны и другие каналы уведомления), клиент идентифицирется по его номеру телефона
- Возможны дополнительние каналы получения
  * Telegram, ...
  * ESB
  * SMS gateway
- К обращению привязывется клиент
- По обращению создается инцидент
- Обращение какое то время может существовать без инцидента но инцидент всегда привязан к обращению
- Обращение характеризуется:
  - Дата и время создания обращения
  - userid : Пользователь (Роль HelpDeskUser) на которого назначено обращение (Keycloak ID)
  - Ссылка на связанную сущность **Клиент**
  - Ссылка на связанную сущность **Инцидент**
  - У обращения есть машина состояний описанная в соответствующей State diagram

### Инцидент
- Создан на основании обращения
- К инциденту привязывается услуга к которой привязана рабочая группа, услуга выбирается из справочника
- Инцидент характеризуется:
  - Дата и время создания инцидента
  - userid : Пользователь (Роль SL3User) на которого назначено обращение (из Keycloak)
  - Бизнес процесс
  - Ссылка на связанную сущность **Услуга**
  - Ссылка на связанную сущность **Обращение**
  - У инцидента есть машина состояний описанная в соответствующей State diagram

### Статус
- Создается в ответ на каждое изменение состояния сущностей **Обращение** и **Инцидент** в соответствии с State Machine
- Статус характеризуется:
  - Дата и время создания статуса
  - Пользователь под которым произошло добавление этого статуса (берется из связанного с ним объекта Инцидент или Обращение)
  - Ссылка на связанную сущность **Инцидент**
  - Ссылка на связанную сущность **Обращение**

### Менеджер задач
Менеджер задач характеризуется:
- Общий список обращений
  - для пользователя (роль HelpDeskUser) видны только обращения , связанные только с ним
  - для менеджера (роль HelpDeskManager) видны обращения для всех пользователей из его подразделения
- Общий список инцидентов
  - для пользователя (роль SL3User) видны только инциденты , связанные только с ним
  - для менеджера  (роль SL3Manager) видны инциденты для всех пользователей из его подразделения
- К каждому обращению может быть привязан инцидент. Если у роли данного пользователя нет прав на изменения данной сущности то он может только работать в режиме просмотра
  - пользователь с ролью HelpDeskUser имеет полный доступ к обращениям и RO доступ к инцидентам
  - пользователь с ролью SL3User имеет полный доступ к инцидентам и RO доступ к обращениям
  - для менеджеров условия такие же - но менеджер дополнительно может видеть все сущности для пользователей своей группы, а пользователь видит только свои
- Витрина с динамическими фильтрами
  - Grafana для UI
  - Prometheus для сбора метрик. В состав метрик должен входить первичный ключ сущности чтобы после выбора данного объекта пользователь мог выполнить какую нибудь активную опреацию например SetStatus
  - Clickhouse DB

## Процессы:

### Авторизация
- В процессе авторизации пользователь вводит свой доменный логин и пароль. Происходит проверка наличия такого пользователя через KeyCloak SSO и в случае успеха ему предоставляется доступ
- На уровне KeyCloak есть возможность задания ролей. В рамках данной концепции рассматриваются роли, указанные выше
- У пользователя на уровне Keycloak есть такие данные как корпоративный email и ID его менеджера. Существует API который по ID пользователя позволяет достать соответствующий объект.

### Операции со списком клиентов
- Возможность просматривать список клиентов
- Возможность поиска по имени клиента
- Возможность редактировать клиента
- Возможность создавать клиента

### Операции со списком инцидентов
- Возможность просматривать список инцидентов по клиенту
- Возможность просматривать список инцидентов
- Возможность поиска инцидента
- Возможность менять статус инцидента в соответствии с State Machine
- Возможность отвязать инцидент от обращения с переводом обращения в статус CLOSED

### Операции со списком обращений
- Возможность просматривать обращения
- Возможность создавать обращение на клиента
- Возможность создавать инцидент по данной услуге с привязкой его к текущему обращению
- Возможность закрывать обращение (если по каким то причинам не удалось создать на него инцидент)
- Может предоставить список услуг c возможностью выбора услуги

### Операции с менеджером задач
- Пользователю создается доска
- Пользователь (роль HelpDeskUser) создает обращение по звонку от клиента и привязывает кдиента к этому обращению
  - клиент найден в Legacy DB - берется оттуда
  - клиент не найден в Legacy DB но найден в current DB - берется оттуда
  - клиент не найден в current DB - создается посредством формы и добавляется в current DB
- Пользователь (роль HelpDeskUser) определят какой услуге из списка соответствует данное обращение и заводит инцидент по данной услуге
- На менеджера SL3 team (привязанного к данной услуге) приходит уведомление на почту о том, что на его группу назначен инцидент и надо назначить исполнителя
- Менеджер уведомляет исполнителя по емайл и тот (пользователь с ролью SL3User) берет на себя текущий инцидент и сам его переводит в статус INWORK (либо это сначала делает менеджер а потом уведомляет пользователя)  
- У инцидента имеется бизнес-процесс, который в виде narative заводится пользователем, который взял на себя инцидент
- По завершению инцидента, он закрывается, автоматически закрывается обращение, нотифицируется (менеджеру с ролью HelpDeskManager, менеджеру с ролью SL3Manager, клиенту)

## Единый язык
- Пользователь
- Менеджер
- Роль
- Статус
- Клиент (таблица CLIENT)
- Услуга (таблица SERVICE)
- Рабочая группа (таблица SERVICEGROUP)
- Обращение  (таблица SERVICEREQUEST)
- Инцидент   (таблица INCIDENT)
- Бизнес-процесс - Указывается в виде narrative в соответствующем поле сущности Инцидент